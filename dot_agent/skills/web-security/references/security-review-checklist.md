# セキュリティレビュー詳細チェックリスト

## 目次

1. [入力バリデーション](#入力バリデーション)
2. [インジェクション対策](#インジェクション対策)
3. [認証（Authentication）](#認証authentication)
4. [認可（Authorization）](#認可authorization)
5. [データ保護](#データ保護)
6. [API セキュリティ](#api-セキュリティ)
7. [ファイル操作とアップロード](#ファイル操作とアップロード)
8. [エラーハンドリングとログ](#エラーハンドリングとログ)
9. [依存関係管理](#依存関係管理)
10. [通信セキュリティ](#通信セキュリティ)
11. [セキュリティヘッダー](#セキュリティヘッダー)
12. [セッション管理](#セッション管理)
13. [暗号化](#暗号化)
14. [ビジネスロジック](#ビジネスロジック)
15. [クライアントサイドセキュリティ](#クライアントサイドセキュリティ)

---

## 入力バリデーション

### 外部入力の検証

#### 必須チェック
- [ ] すべての外部入力（HTTP パラメータ、ヘッダー、Cookie、ファイルアップロード）を検証している
- [ ] クライアント側の検証だけでなく、サーバー側でも検証している
- [ ] 検証をバイパスする方法がない（すべてのエンドポイントで実施）

#### 検証方式
- [ ] 許可リスト（ホワイトリスト）方式を使用している
- [ ] 拒否リスト（ブラックリスト）のみに依存していない
- [ ] 正規表現を使用する場合、ReDoS（Regular Expression Denial of Service）に対して脆弱でない

### 型・形式・範囲の検証

#### 型チェック
- [ ] データ型が期待通りか検証（文字列、数値、真偽値など）
- [ ] 型の強制変換が安全に行われている
- [ ] 数値のオーバーフロー・アンダーフローをチェック

#### 長さ制限
- [ ] 文字列の最小・最大長を検証
- [ ] 配列・リストのサイズを制限
- [ ] ファイルサイズを制限

#### 形式検証
- [ ] メールアドレス、URL、日付などの形式を検証
- [ ] 特殊文字の使用を適切に制限
- [ ] エンコーディングを検証（UTF-8 など）

#### 範囲チェック
- [ ] 数値の最小・最大値を検証
- [ ] 日付・時刻の範囲を検証
- [ ] 列挙型の値を検証

### 特殊なケース

#### パストラバーサル対策
- [ ] ファイルパスに `../` や絶対パスが含まれていないか検証
- [ ] ファイルパスを正規化してから検証
- [ ] 許可されたディレクトリ内のファイルのみアクセス可能

#### ID・キーの検証
- [ ] リソース ID が正しい形式か検証（UUID、整数など）
- [ ] 存在しない ID へのアクセスを適切に処理
- [ ] ID の推測が困難（連番を避ける）

#### 文字エンコーディング
- [ ] 複数のエンコーディングを利用した攻撃への対策
- [ ] Unicode の正規化を考慮
- [ ] Null バイトインジェクション対策

---

## インジェクション対策

### SQL インジェクション

#### クエリの構築
- [ ] プリペアドステートメント（パラメータ化クエリ）を使用
- [ ] 文字列連結によるクエリ構築を避ける
- [ ] ORM を使用する場合も、生の SQL には注意

#### データベースアクセス
- [ ] 最小権限の原則（アプリケーションから必要最小限の権限のみ）
- [ ] ストアドプロシージャを使用する場合も、動的 SQL に注意
- [ ] エラーメッセージでデータベース構造を漏らさない

### OS コマンドインジェクション

#### コマンド実行
- [ ] 可能な限りシステムコマンドの実行を避ける
- [ ] 専用のライブラリや API を使用
- [ ] やむを得ずコマンドを実行する場合、入力を厳格に検証

#### シェル経由の実行
- [ ] シェル経由のコマンド実行を避ける
- [ ] コマンドとパラメータを分離
- [ ] メタ文字（`;`, `|`, `&`, `$`, `` ` `` など）を含む入力を拒否

### XSS（Cross-Site Scripting）

#### 出力エスケープ
- [ ] すべての動的コンテンツをコンテキストに応じてエスケープ
  - HTML コンテキスト: `&`, `<`, `>`, `"`, `'`
  - JavaScript コンテキスト: JSON エンコード
  - URL コンテキスト: URL エンコード
  - CSS コンテキスト: CSS エスケープ
- [ ] テンプレートエンジンの自動エスケープ機能を使用
- [ ] innerHTML, dangerouslySetInnerHTML の使用を最小限に

#### Content Security Policy
- [ ] CSP ヘッダーを設定
- [ ] `'unsafe-inline'`, `'unsafe-eval'` の使用を避ける
- [ ] nonce または hash ベースの CSP を使用

#### Cookie の保護
- [ ] HttpOnly フラグを設定（JavaScript からのアクセス防止）
- [ ] Secure フラグを設定（HTTPS のみ）
- [ ] SameSite 属性を設定

### その他のインジェクション

#### LDAP インジェクション
- [ ] LDAP クエリをパラメータ化
- [ ] 特殊文字のエスケープ

#### XML インジェクション
- [ ] XML パーサーの外部エンティティ処理を無効化（XXE 対策）
- [ ] XML 入力の検証

#### NoSQL インジェクション
- [ ] クエリオブジェクトの型検証
- [ ] オペレーター（`$where`, `$ne` など）の使用制限

#### テンプレートインジェクション
- [ ] ユーザー入力をテンプレートに直接埋め込まない
- [ ] サンドボックス化されたテンプレートエンジンの使用

---

## 認証（Authentication）

### パスワード管理

#### パスワードポリシー
- [ ] 最小文字数の設定（推奨: 12 文字以上）
- [ ] 複雑性要件（大小文字、数字、記号）
- [ ] よく使われるパスワードのブロック
- [ ] パスワード履歴のチェック（再利用防止）

#### パスワード保存
- [ ] 適切なハッシュ関数を使用（bcrypt, Argon2, scrypt）
- [ ] ユーザーごとにユニークなソルトを使用
- [ ] ペッパーの使用を検討
- [ ] 平文やリバーシブルな暗号化を使用していない

#### パスワードリセット
- [ ] 安全なトークンの生成（暗号学的に安全な乱数）
- [ ] トークンの有効期限を設定
- [ ] トークンは一度きりの使用
- [ ] リセット時に既存セッションを無効化

### ログイン保護

#### ブルートフォース対策
- [ ] レート制限を実装
- [ ] アカウントロックアウト（一時的）
- [ ] CAPTCHA の使用（過度な試行時）
- [ ] タイミング攻撃への対策（定時間応答）

#### 多要素認証（MFA）
- [ ] 重要な操作に MFA を要求
- [ ] 複数の認証要素の組み合わせ
- [ ] リカバリーコードの提供
- [ ] MFA バイパスの防止

### 資格情報の扱い

#### 送信
- [ ] HTTPS でのみ送信
- [ ] URL パラメータに資格情報を含めない
- [ ] Referer ヘッダーに資格情報が漏れない

#### 保存
- [ ] ログに資格情報を記録しない
- [ ] ソースコードに資格情報を埋め込まない
- [ ] 環境変数やシークレット管理サービスを使用

---

## 認可（Authorization）

### アクセス制御の基本

#### 認可チェック
- [ ] すべてのリソースアクセスで認可チェックを実施
- [ ] サーバーサイドで認可チェックを実施（クライアント側のみに依存しない）
- [ ] デフォルト拒否の原則

#### 垂直権限昇格の防止
- [ ] ユーザーのロール・権限を検証
- [ ] 管理者機能へのアクセスを適切に制限
- [ ] ロールの変更は厳格に管理

#### 水平権限昇格の防止
- [ ] リソースの所有者を検証
- [ ] ユーザー ID と対象リソースの紐付けを確認
- [ ] ID パラメータの改ざんを防止（IDOR 対策）

### アクセス制御モデル

#### RBAC（Role-Based Access Control）
- [ ] ロールが適切に定義されている
- [ ] ユーザーに必要最小限のロールを付与
- [ ] ロールの階層が適切

#### ABAC（Attribute-Based Access Control）
- [ ] 属性ベースのポリシーが適切に定義
- [ ] ポリシーの評価ロジックが正しい

### API・リソースの保護

#### エンドポイント保護
- [ ] すべての API エンドポイントに認証・認可を実装
- [ ] 内部 API も適切に保護
- [ ] GraphQL の場合、フィールドレベルの認可を実装

#### リソース識別子
- [ ] 推測困難なリソース ID を使用（UUID など）
- [ ] 列挙攻撃への対策

---

## データ保護

### 機密情報の扱い

#### 機密データの特定
- [ ] パスワード、個人情報、決済情報などを特定
- [ ] データの重要度を分類
- [ ] 不要な機密データを保存しない

#### 保存時の保護
- [ ] 機密データを暗号化して保存
- [ ] 暗号化キーを安全に管理
- [ ] データベースの暗号化を検討（TDE など）

#### 表示時の保護
- [ ] マスキング処理（クレジットカード番号の一部のみ表示など）
- [ ] 機密情報を URL パラメータに含めない
- [ ] ログに機密情報を記録しない

### 個人情報保護

#### プライバシー要件
- [ ] GDPR, CCPA などの法的要件を遵守
- [ ] データの保持期限を設定
- [ ] ユーザーによるデータの削除要求に対応

#### 同意管理
- [ ] データ収集時の同意を取得
- [ ] 同意の範囲を明確化
- [ ] 同意の撤回機能を提供

### データの破棄

#### 削除処理
- [ ] 不要になったデータの削除
- [ ] 論理削除と物理削除の使い分け
- [ ] バックアップからの削除も考慮

---

## API セキュリティ

### レート制限・スロットリング

#### レート制限の実装
- [ ] API エンドポイントごとにレート制限を設定
- [ ] ユーザー/IP アドレス単位での制限
- [ ] 適切なレート制限値の設定

#### スロットリング
- [ ] バースト的なトラフィックへの対策
- [ ] リソース消費の多い操作に厳しい制限
- [ ] レート制限超過時の適切なレスポンス（429 Too Many Requests）

### CORS（Cross-Origin Resource Sharing）

#### CORS ヘッダー
- [ ] Access-Control-Allow-Origin を適切に設定（`*` を避ける）
- [ ] Access-Control-Allow-Methods を必要なメソッドのみに制限
- [ ] Access-Control-Allow-Headers を必要なヘッダーのみに制限
- [ ] Access-Control-Allow-Credentials の使用に注意

#### プリフライトリクエスト
- [ ] OPTIONS リクエストへの適切な応答
- [ ] Access-Control-Max-Age の設定

### API 設計

#### バージョニング
- [ ] API のバージョン管理
- [ ] 後方互換性の考慮
- [ ] 非推奨 API の適切な廃止

#### ペイロード
- [ ] リクエスト・レスポンスのサイズ制限
- [ ] 必要最小限のデータのみを返す
- [ ] ページングの実装

#### エラーレスポンス
- [ ] 一貫したエラーレスポンス形式
- [ ] 詳細すぎる情報を含めない
- [ ] 適切な HTTP ステータスコードの使用

---

## ファイル操作とアップロード

### ファイルアップロード

#### アップロード制限
- [ ] ファイルサイズの制限
- [ ] ファイルタイプの検証（拡張子とMIME タイプの両方）
- [ ] マジックバイトの検証
- [ ] アップロード頻度の制限

#### ファイルの保存
- [ ] アップロードされたファイルを公開ディレクトリの外に保存
- [ ] ファイル名をサニタイズ（パストラバーサル対策）
- [ ] ランダムなファイル名を使用
- [ ] 実行権限を付与しない

#### ファイルの処理
- [ ] ウイルススキャンの実施
- [ ] 画像の場合、メタデータの削除を検討
- [ ] 圧縮ファイルの展開時の Zip Bomb 対策

### ファイルのダウンロード

#### アクセス制御
- [ ] ダウンロード権限の検証
- [ ] 直接 URL でのアクセスを防止

#### ダウンロードレスポンス
- [ ] Content-Disposition ヘッダーの設定（`attachment; filename="..."`）
- [ ] Content-Type の適切な設定
- [ ] X-Content-Type-Options: nosniff の設定

---

## エラーハンドリングとログ

### エラーハンドリング

#### エラーメッセージ
- [ ] 本番環境で詳細なエラーメッセージを表示しない
- [ ] スタックトレースを表示しない
- [ ] データベース構造などの内部情報を漏らさない
- [ ] カスタムエラーページの使用

#### 例外処理
- [ ] すべての例外を適切に処理
- [ ] デフォルトの例外ハンドラを設定
- [ ] エラー時は安全側に倒す（フェイルセーフ）

### ログ記録

#### 記録すべきイベント
- [ ] 認証の成功・失敗
- [ ] アクセス制御の失敗
- [ ] 入力検証の失敗
- [ ] 重要な操作（作成、変更、削除）
- [ ] 設定変更
- [ ] 権限の変更

#### ログの内容
- [ ] タイムスタンプ（UTC 推奨）
- [ ] ユーザー識別子
- [ ] IP アドレス
- [ ] イベントタイプ
- [ ] 操作対象のリソース
- [ ] 操作の結果

#### ログに記録してはいけない情報
- [ ] パスワード
- [ ] セッション ID
- [ ] クレジットカード情報
- [ ] 個人識別可能情報（必要最小限に）
- [ ] API キー・トークン

#### ログの保護
- [ ] ログへのアクセス制御
- [ ] ログの改ざん防止
- [ ] 適切な保存期間
- [ ] ログのバックアップ

---

## 依存関係管理

### 依存関係の管理

#### インベントリ
- [ ] すべての依存関係をリストアップ
- [ ] 直接・間接依存関係を把握
- [ ] バージョンを記録

#### 信頼できるソース
- [ ] 公式リポジトリからのみ取得
- [ ] パッケージの整合性検証（チェックサム、署名）
- [ ] プライベートリポジトリの活用

### 脆弱性管理

#### スキャン
- [ ] 定期的な脆弱性スキャンの実施
- [ ] CI/CD パイプラインへの統合
- [ ] 脆弱性の重要度評価

#### 更新
- [ ] 定期的な更新スケジュール
- [ ] セキュリティパッチの優先適用
- [ ] 更新前のテスト
- [ ] サポート終了したコンポーネントの対応

---

## 通信セキュリティ

### HTTPS

#### TLS の設定
- [ ] TLS 1.2 以上を使用（推奨は TLS 1.3）
- [ ] 強力な暗号スイートのみを有効化
- [ ] 弱い暗号の無効化（RC4, 3DES など）
- [ ] Forward Secrecy の有効化

#### 証明書
- [ ] 有効な SSL/TLS 証明書を使用
- [ ] 証明書の有効期限を監視
- [ ] ワイルドカード証明書の適切な使用

#### HTTP の無効化
- [ ] すべての通信を HTTPS に強制
- [ ] HTTP から HTTPS へのリダイレクト
- [ ] HSTS ヘッダーの設定

### Mixed Content

#### 混在コンテンツの排除
- [ ] HTTPS ページで HTTP リソースを読み込まない
- [ ] すべてのサブリソースを HTTPS 化
- [ ] upgrade-insecure-requests ディレクティブの使用

---

## セキュリティヘッダー

### 必須ヘッダー

#### Content-Security-Policy
- [ ] CSP ヘッダーを設定
- [ ] 適切なディレクティブの設定
- [ ] Report-Only モードでテスト

#### Strict-Transport-Security
- [ ] HSTS ヘッダーを設定
- [ ] 適切な max-age（推奨: 1年以上）
- [ ] includeSubDomains の検討

#### X-Content-Type-Options
- [ ] `nosniff` を設定
- [ ] 正しい Content-Type の設定

#### X-Frame-Options
- [ ] DENY または SAMEORIGIN を設定
- [ ] CSP の frame-ancestors との併用

#### Referrer-Policy
- [ ] 適切なポリシーを設定（推奨: `strict-origin-when-cross-origin`）

#### Permissions-Policy
- [ ] 不要な機能を無効化
- [ ] 使用する機能のみを許可

---

## セッション管理

### セッション生成

#### セッション ID
- [ ] 暗号学的に安全なセッション ID
- [ ] 十分な長さとランダム性
- [ ] ログイン成功時に新しいセッション ID を発行
- [ ] ログアウト時のセッション無効化

### セッション保護

#### Cookie の設定
- [ ] HttpOnly フラグ
- [ ] Secure フラグ（HTTPS のみ）
- [ ] SameSite 属性（Strict または Lax）
- [ ] 適切な Domain と Path

#### タイムアウト
- [ ] セッションタイムアウトの設定
- [ ] アイドルタイムアウトの実装
- [ ] 絶対タイムアウトの実装

#### セッション固定化対策
- [ ] 認証前後でセッション ID を変更
- [ ] セッション ID の推測困難性
- [ ] セッション ID を URL に含めない

---

## 暗号化

### アルゴリズムの選択

#### 推奨アルゴリズム
- [ ] AES-256（対称鍵暗号）
- [ ] RSA-2048 以上または ECC（非対称鍵暗号）
- [ ] SHA-256 以上（ハッシュ）
- [ ] bcrypt, Argon2, scrypt（パスワードハッシュ）

#### 非推奨・禁止
- [ ] MD5, SHA-1（ハッシュ）
- [ ] DES, 3DES, RC4（暗号化）
- [ ] RSA-1024 以下（鍵長が短い）

### 鍵管理

#### 鍵の保管
- [ ] 鍵をコードに埋め込まない
- [ ] 環境変数または Key Management Service を使用
- [ ] 鍵へのアクセスを制限

#### 鍵のローテーション
- [ ] 定期的な鍵のローテーション
- [ ] 侵害時の鍵の無効化手順

---

## ビジネスロジック

### リソース消費の制限

#### レート制限
- [ ] リクエストのレート制限
- [ ] リソース消費の多い操作の制限

#### ページング
- [ ] 大量データ取得時のページング強制
- [ ] デフォルトと最大ページサイズの設定

#### タイムアウト
- [ ] 処理時間の制限
- [ ] 外部 API 呼び出しのタイムアウト

### ビジネスフロー

#### ステップのスキップ防止
- [ ] 必須ステップの強制
- [ ] ステップの順序検証
- [ ] 状態遷移の検証

#### トランザクション
- [ ] トランザクションの整合性確保
- [ ] 同時実行制御
- [ ] デッドロック対策

#### リプレイ攻撃
- [ ] トークンやノンスの使用
- [ ] タイムスタンプの検証
- [ ] 一度きりの操作の保証

---

## クライアントサイドセキュリティ

### JavaScript

#### セキュアコーディング
- [ ] eval() の使用を避ける
- [ ] innerHTML の使用を最小限に
- [ ] 動的コード実行の制限

#### サードパーティスクリプト
- [ ] 信頼できるソースからのみ読み込み
- [ ] Subresource Integrity（SRI）の使用
- [ ] CSP での制限

### ブラウザストレージ

#### 機密情報の保存
- [ ] localStorage/sessionStorage に機密情報を保存しない
- [ ] Cookie には必要最小限の情報のみ

#### データの暗号化
- [ ] クライアント側で機密データを暗号化する場合、適切な実装

---

## まとめ

### 優先度の高い項目（Critical）

1. **認証・認可**
   - すべてのエンドポイントで認証・認可チェック
   - パスワードの適切なハッシュ化
   - セッション管理の適切な実装

2. **インジェクション対策**
   - SQL インジェクション対策（プリペアドステートメント）
   - XSS 対策（出力エスケープ、CSP）
   - OS コマンドインジェクション対策

3. **データ保護**
   - 機密データの暗号化
   - HTTPS の強制
   - ログへの機密情報の非記録

4. **入力検証**
   - すべての外部入力の検証
   - サーバーサイドでの検証
   - 許可リスト方式

### セキュリティレビューのワークフロー

1. **事前準備**
   - システムのアーキテクチャ理解
   - データフロー図の確認
   - 脅威モデルの確認

2. **コードレビュー**
   - チェックリストに沿ったレビュー
   - 優先度の高い項目から確認
   - 自動化ツールの活用

3. **テスト**
   - セキュリティテストの実施
   - ペネトレーションテストの検討
   - 脆弱性スキャンの実施

4. **報告**
   - 発見事項の文書化
   - 重要度の評価
   - 修正案の提示

5. **フォローアップ**
   - 修正の確認
   - 再テストの実施
   - ナレッジの共有

### 継続的なセキュリティ

- 定期的なセキュリティレビューの実施
- セキュリティトレーニングの実施
- セキュリティインシデント対応計画の策定
- 脆弱性情報の継続的な収集
- セキュリティツールの活用と更新
