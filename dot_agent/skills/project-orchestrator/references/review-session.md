# レビューフェーズ詳細

## 目次

- [モデル選択](#モデル選択)
- [レビューの流れ](#レビューの流れ)
- [BE/FE orchestrator によるレビュー](#befe-orchestrator-によるレビュー)
  - [差分の取得](#差分の取得)
  - [レビュー観点](#レビュー観点)
  - [開発者への報告フォーマット](#開発者への報告フォーマット)
  - [fix コマンドの生成](#fix-コマンドの生成)
  - [修正案内テンプレート](#修正案内テンプレート)
- [レビュー → 修正 → 再レビューのサイクル](#レビュー--修正--再レビューのサイクル)
  - [fix サイクルでのコミット方針](#fix-サイクルでのコミット方針)
- [承認後の rebase + マージ](#承認後の-rebase--マージ)
  - [承認時の案内テンプレート](#承認時の案内テンプレート)
- [project-orchestrator による横断レビュー](#project-orchestrator-による横断レビュー)
  - [横断レビュー観点](#横断レビュー観点)
  - [横断レビュー結果の報告](#横断レビュー結果の報告)
  - [修正が必要な場合](#修正が必要な場合)
- [全タスク完了後](#全タスク完了後)

## モデル選択

レビューフェーズは **Opus** モデルで実行する（`claude --model opus`）。
修正（fix コマンド）は **Sonnet** モデルで実行する（`claude --model sonnet`）。

## レビューの流れ

```
1. BE/FE orchestrator が担当タスクをレビュー [Opus]
2. 修正要求 → fix コマンド生成 → 修正 [Sonnet] → 再レビュー [Opus]（承認まで繰り返し）
3. 承認 → rebase → feature ブランチへマージ
4. 全タスク完了後、project-orchestrator が横断レビュー [Opus]
5. 横断レビュー承認 → feature → develop マージ
```

## BE/FE orchestrator によるレビュー

### 差分の取得

```bash
cd .worktrees/task-{作業名}
git diff feature/{機能名}...HEAD
```

### レビュー観点

#### スキル規約によるレビュー

実装時に使用したスキルを参照し、以下を確認する:

- アーキテクチャ原則への準拠
- 設計規約（命名、ディレクトリ構成、依存方向等）の遵守
- スキル固有のパターンとの整合性

#### 専門観点

- **BE orchestrator**: API 設計、セキュリティ、データ整合性、パフォーマンス、可観測性
- **FE orchestrator**: コンポーネント設計、状態管理、アクセシビリティ、パフォーマンス、スタイリング

#### 実装計画との整合性

計画フェーズで策定した内容と比較:

- 仕様通りに実装されているか
- 作成/変更ファイル一覧との一致
- テスト要件の充足

### 開発者への報告フォーマット

```
=== レビュー結果: {タスク名} ===

【良い点】
- {ポジティブなフィードバック}

【修正が必要な項目】

必須:
1. [{ファイルパス}] {問題の概要}
   → {修正内容}

2. [{ファイルパス}] {問題の概要}
   → {修正内容}

推奨:
3. [{ファイルパス}] {改善提案}
   → {修正内容}

【判定】
- [ ] 承認（修正不要）
- [x] 修正要求（上記の必須項目を修正後、再レビュー）
```

### fix コマンドの生成

修正が必要な場合、fix コマンドを生成する。
テンプレートは [slash-command-templates.md](slash-command-templates.md) を参照。

### 修正案内テンプレート

```
=== レビュー結果: 修正が必要 ===

{レビュー内容}

fix コマンドを生成しました。

【次のアクション】
1. ターミナルで新しいタブを開く
2. プロジェクトルートで `claude --model sonnet` を起動（修正には Sonnet を使用）
3. 以下のコマンドを入力して放置:
   /fix-{タスク名}
4. 修正プッシュ後、このタブに戻ってきてください
```

## レビュー → 修正 → 再レビューのサイクル

```
対話環境                    ターミナル（非対話）
┌───────────────┐
│ 差分確認       │
│ スキル規約で   │
│ レビュー       │
│ 開発者と対話   │
├───────────────┤
│ 修正要?        │
│  No → 承認     │
│  Yes ↓         │
├───────────────┤
│ fix コマンド   │──→ /fix-{task} 実行
│ 生成           │    修正→品質ゲート→push
├───────────────┤←── push 完了
│ 再レビュー     │
│ (繰り返し)     │
└───────────────┘
```

- 回数制限なし。良いコードになるまで繰り返す
- 各サイクルで fix コマンドは上書き（最新の修正指示のみ保持）
- 推奨項目のみ残った場合、開発者と相談して承認するか修正するか判断

### fix サイクルでのコミット方針

修正エージェントには修正項目ごとにこまめにコミットさせること。これにより:
- 再レビュー時に差分が追いやすくなる
- 問題のある修正だけを revert できる

## 承認後の rebase + マージ

BE/FE orchestrator の責務:

```bash
# 1. タスクブランチを feature ブランチに rebase
cd .worktrees/task-{作業名}
git fetch origin
git rebase feature/{機能名}

# コンフリクト発生時は解消（担当オーケストレータの責務）
# git add {解消したファイル} && git rebase --continue

# 2. force push
git push --force-with-lease origin task/{作業名}

# 3. feature ブランチにマージ
git checkout feature/{機能名}
git merge task/{作業名}
git push origin feature/{機能名}
```

### 承認時の案内テンプレート

```
=== レビュー承認: {タスク名} ===

rebase + feature ブランチへのマージを実行します。

(全タスク完了の場合)
→ project-orchestrator の横断レビューに進みます

(未完了タスクがある場合)
→ 次のタスクのレビューに進みます
```

## project-orchestrator による横断レビュー

全タスクが feature ブランチにマージされた後、project-orchestrator が横断レビューを実施する。

### 横断レビュー観点

#### BE/FE 整合性

- API インターフェース（エンドポイント、リクエスト/レスポンス型）が一致しているか
- 共有の型定義が整合しているか
- 認証/認可フローが BE/FE で一貫しているか
- エラーハンドリングの方針が統一されているか

#### 全体アーキテクチャ

- ディレクトリ構成がプロジェクト方針に沿っているか
- 依存関係の方向が正しいか
- 命名規則がプロジェクト全体で統一されているか

#### 非機能要件

- セキュリティ対策が適切か
- パフォーマンスに問題がないか
- 可観測性が確保されているか

### 横断レビュー結果の報告

```
=== 横断レビュー結果: feature/{機能名} ===

【BE/FE 整合性】
- {確認結果}

【全体アーキテクチャ】
- {確認結果}

【修正が必要な項目】
- [{担当: BE/FE}] {問題の概要} → {修正内容}

【判定】
- [ ] 承認 → feature → develop マージ可能
- [x] 修正要求 → 担当オーケストレータに差し戻し
```

### 修正が必要な場合

該当する BE/FE orchestrator に差し戻し:

```
{担当オーケストレータ名} に以下の修正を依頼します:
- {修正項目}
```

## 全タスク完了後

```
=== 全タスク完了 ===

feature/{機能名} の全タスクが完了し、横断レビューも承認されました。

【次のアクション】
1. feature/{機能名} → develop の PR を作成・マージしてください
2. クリーンアップを実行してください:

# worktree 削除
git worktree remove .worktrees/task-{作業名1}
git worktree remove .worktrees/task-{作業名2}

# スラッシュコマンドファイル削除
rm -f .claude/commands/worker-*.md
rm -f .claude/commands/fix-*.md

# (任意) 作業ブランチ削除
git branch -d task/{作業名1}
git branch -d task/{作業名2}
```
